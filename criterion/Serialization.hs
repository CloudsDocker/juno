{-# OPTIONS_GHC -fno-warn-orphans #-}
{-# LANGUAGE FlexibleInstances #-}
{-# LANGUAGE StandaloneDeriving #-}
{-# LANGUAGE FunctionalDependencies #-}
{-# LANGUAGE MultiParamTypeClasses #-}
{-# LANGUAGE GeneralizedNewtypeDeriving #-}
{-# LANGUAGE DeriveGeneric #-}
{-# LANGUAGE Rank2Types #-}
{-# LANGUAGE RecordWildCards #-}
{-# LANGUAGE TemplateHaskell #-}
{-# LANGUAGE OverloadedStrings #-}

module Main where

import Criterion.Main

import Codec.Crypto.RSA
import qualified Data.Map as Map
import Data.Set (Set)
import qualified Data.Set as Set
import Data.Sequence (Seq)
import qualified Data.Sequence as Seq
import Data.Serialize
import Data.ByteString (ByteString)
import qualified Data.ByteString.Lazy as LB
import GHC.Generics

import Juno.Runtime.Types

main :: IO ()
main = defaultMain
  [ bgroup "CMD (Old Method)" [
      bench "Verify CMD" $
        whnf oldCmdVerify ocmdSignedRPC
    , bench "Decode & Verify Raw BS" $
        whnf oldCmdDecode ocmdSerRPC
    , bench "Sign and Encode" $
        whnf (encode . oldCmdSign) ocmdRPC
    , bench "Encode pre-signed" $
        whnf encode ocmdSignedRPC
    ]
  , bgroup "CMD (Digest)" [
      bench "Verify & Decode SignedRPC" $
        whnf ((\(Right v) -> v) . fromWire keySet :: SignedRPC -> Command) cmdSignedRPC1
    , bench "Verify & Decode Raw BS" $
        whnf (either error ((\(Right v) -> v) . fromWire keySet) . decode :: ByteString -> Command) cmdSignedRpc1BS
    , bench "Sign and Encode" $
        whnf (encode . toWire nodeIdLeader privKeyLeader) cmdRPC1
    , bench "Encode pre-signed" $
        whnf (encode . toWire nodeIdLeader privKeyLeader) cmdRpc1Received
    ]
--  , bgroup "Empty AE (Digest)" [
--      bench "Verify & Decode SignedRPC" $
--        whnf ((\(Right v) -> v) . fromWire keySet :: SignedRPC -> AppendEntries) aeEmptySignedRPC
--    , bench "Verify & Decode Raw BS" $
--        whnf (either error ((\(Right v) -> v) . fromWire keySet) . decode :: ByteString -> AppendEntries) aeEmptySignedRpcBS
--    , bench "Sign and Encode" $
--        whnf (encode . toWire nodeIdLeader privKeyLeader) aeEmptyRPC
--    , bench "Encode pre-signed" $
--        whnf (encode . toWire nodeIdLeader privKeyLeader) aeEmptyRpcReceived
--    ]
--  , bgroup "AE Two LogEntries (Old Method)" [
--      bench "Verify AE" $
--        whnf oldAeVerify oaeRPC'
--    , bench "Decode & Verify Raw BS" $
--        whnf oldAeDecode oaeSerRPC
--    , bench "Sign and Encode" $
--        whnf (encode . oldAeSign) oaeRPC
--    , bench "Encode pre-signed" $
--        whnf encode oaeRPC'
--    ]
--  , bgroup "AE Two LogEntries (Digest)" [
--      bench "Verify & Decode SignedRPC" $
--        whnf ((\(Right v) -> v) . fromWire keySet :: SignedRPC -> AppendEntries) aeSignedRPC
--    , bench "Verify & Decode Raw BS" $
--        whnf (either error ((\(Right v) -> v) . fromWire keySet) . decode :: ByteString -> AppendEntries) aeSignedRpcBS
--    , bench "Sign and Encode" $
--        whnf (encode . toWire nodeIdLeader privKeyLeader) aeRPC
--    , bench "Encode pre-signed" $
--        whnf (encode . toWire nodeIdLeader privKeyLeader) aeRpcReceived
--    ]
  ]

-- ##########################################################
-- ####### All the stuff we need to actually run this #######
-- ##########################################################

-- #######################################################################
-- NodeID's + Keys for Client (10002), Leader (10000) and Follower (10001)
-- #######################################################################
nodeIdLeader, nodeIdFollower, nodeIdClient :: NodeID
nodeIdLeader = NodeID "localhost" 10000
nodeIdFollower = NodeID "localhost" 10001
nodeIdClient = NodeID "localhost" 10002

privKeyLeader, privKeyFollower, privKeyClient :: PrivateKey
privKeyLeader = PrivateKey {private_pub = PublicKey {public_size = 128, public_n = 143263094045483237413672742110806909557046787889291330401749751443369156063681858601975919855307842489235960299544273678048933580691559560784431105517057635455255146471809872702665529086654681916300619471314964172045542731305151294857601932085639875342307156397078951049517603494584167375520281289470658070821, public_e = 65537}, private_d = 140377589915906999969388627494845466088238301690443892219802001746171431327974394828006891455945553216217795482793454427014791152345543438285149034941924235746522892080902348016215668071955199106399324875029853484007717381391953823509488195274062416447784661420846624275968351998125095977024136079063438454573, private_p = 12322642714345408536017571405614321258874483339719624321916754832065122801766236021586867686343013657373047283868589815935715896579364378876832667679254511, private_q = 11626004045277029718858993149611335122220600272505403342820851017531587390596697925738903796399688718560222927972268099165561188726104695590946150339079211, private_dP = 0, private_dQ = 0, private_qinv = 0}
privKeyFollower = PrivateKey {private_pub = PublicKey {public_size = 128, public_n = 119734587589518990148219161431156442604320649075830559997839966910663760506098828080257917947217357217568770968568912187185962902759815037372954576824527044099430785533420222306796220280055320145935645419601056718741502607027250695371136410369973248364689692994952014429670625261164422497595026998844835804983, public_e = 65537}, private_d = 42831647335835988907561377856661605511629969283515749097294050448656502453651844385821240342929394427707741681601684198489215470532693039598570991944614668183055075411290182049507917324514952869097870506339758634913916485661089305995857595662086838794391326313280954244219693809814987046399359265702339099489, private_p = 11149448648727520741344534515175453743631376308425947520306431957535748167889134814371076822226395101702128442944739479928637847681449963148838547576756349, private_q = 10739059065775796910540038518886518635626397455942041662941214452735467326713118657850293569672623570913891867630588355426481112134066746585198501737910467, private_dP = 0, private_dQ = 0, private_qinv = 0}
privKeyClient = PrivateKey {private_pub = PublicKey {public_size = 128, public_n = 106252368639070633938244027838812466487634971459399633948485579058064750184804467292629472697808998989066368983424031700876663753846147139515953278402011718215436563286250115914185011343557536197541367961085118851954966833333275851022828003953887053315417450038702459750117667520446623825484282212798093912159, public_e = 65537}, private_d = 75403076323825260750931405019383386543073605560297504849323524061393311661276393019407420933249900574980358500542720758900663053353532467335207150543954743785029033469647938675096518795993183160202689835102089214515513968926523692041172327354495493314285943948188194911060155947074855453679649323415024020601, private_p = 10533116134787235979430606573617029447681668880981449216358619427605789055226200529358027255251243796670635247358375658748310100973047917014533032664997323, private_q = 10087458191802883990555912812743556937883302367567842795334469443655041316171806703582222153719435177125303551647636770526849653208414415981311349629193533, private_dP = 0, private_dQ = 0, private_qinv = 0}

pubKeyLeader, pubKeyFollower, pubKeyClient :: PublicKey
pubKeyLeader = private_pub privKeyLeader
pubKeyFollower = private_pub privKeyFollower
pubKeyClient = private_pub privKeyClient

keySet :: KeySet
keySet = KeySet
  { _ksCluster = Map.fromList [(nodeIdLeader, pubKeyLeader),(nodeIdFollower, pubKeyFollower)]
  , _ksClient = Map.fromList [(nodeIdClient, pubKeyClient)] }


-- #####################################
-- Commands, with and without provenance
-- #####################################
cmdRPC1, cmdRPC2, cmdRpc1Received :: Command
cmdRPC1 = Command
  { _cmdEntry = CommandEntry "CreateAccount foo"
  , _cmdClientId = nodeIdClient
  , _cmdRequestId = RequestId 0
  , _cmdProvenance = NewMsg }
cmdRPC2 = Command
  { _cmdEntry = CommandEntry "CreateAccount foo"
  , _cmdClientId = nodeIdClient
  , _cmdRequestId = RequestId 1
  , _cmdProvenance = NewMsg }
cmdRpc1Received = Command
  { _cmdEntry = CommandEntry "CreateAccount foo"
  , _cmdClientId = nodeIdClient
  , _cmdRequestId = RequestId 0
  , _cmdProvenance = ReceivedMsg {_pDig = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10002}, _digSig = "x\237u\EOT\203\218\162\SOH\185#\137\CAN\142\143-d\156\151;\231\182}>\136\DC3\186:\GS!C\134\r\NAK\193\"-cy\185\181\t\200ff\154\201u\202\146\ESC\179\DC1_\152\200(YU\218\"`\ESC\219\152q\189\"\213K\202\215V\DC1\162\209\168M\133\188$\ENQ1\192\237{\210\201f_M\189\212\DEL\164\208\199\184EBt[Cw\160\232\217\146\144+\203\178\ENQ\DEL\209\150\195\215}!\247\220E)\180]\206]\ACK", _digPubkey = PublicKey {public_size = 128, public_n = 106252368639070633938244027838812466487634971459399633948485579058064750184804467292629472697808998989066368983424031700876663753846147139515953278402011718215436563286250115914185011343557536197541367961085118851954966833333275851022828003953887053315417450038702459750117667520446623825484282212798093912159, public_e = 65537}, _digType = CMD}, _pOrig = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL"}}

cmdSignedRPC1, cmdSignedRPC2 :: SignedRPC
-- cmdSignedRPC1 = toWire nodeIdClient privKeyClient cmdRPC1
cmdSignedRPC1 = SignedRPC {_sigDigest = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10002}, _digSig = "x\237u\EOT\203\218\162\SOH\185#\137\CAN\142\143-d\156\151;\231\182}>\136\DC3\186:\GS!C\134\r\NAK\193\"-cy\185\181\t\200ff\154\201u\202\146\ESC\179\DC1_\152\200(YU\218\"`\ESC\219\152q\189\"\213K\202\215V\DC1\162\209\168M\133\188$\ENQ1\192\237{\210\201f_M\189\212\DEL\164\208\199\184EBt[Cw\160\232\217\146\144+\203\178\ENQ\DEL\209\150\195\215}!\247\220E)\180]\206]\ACK", _digPubkey = PublicKey {public_size = 128, public_n = 106252368639070633938244027838812466487634971459399633948485579058064750184804467292629472697808998989066368983424031700876663753846147139515953278402011718215436563286250115914185011343557536197541367961085118851954966833333275851022828003953887053315417450038702459750117667520446623825484282212798093912159, public_e = 65537}, _digType = CMD}, _sigBody = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL"}
cmdSignedRPC2 = toWire nodeIdClient privKeyClient cmdRPC2

cmdSignedRpc1BS :: ByteString
-- cmdSignedRpc1BS = encode cmdSignedRPC1
cmdSignedRpc1BS = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128x\237u\EOT\203\218\162\SOH\185#\137\CAN\142\143-d\156\151;\231\182}>\136\DC3\186:\GS!C\134\r\NAK\193\"-cy\185\181\t\200ff\154\201u\202\146\ESC\179\DC1_\152\200(YU\218\"`\ESC\219\152q\189\"\213K\202\215V\DC1\162\209\168M\133\188$\ENQ1\192\237{\210\201f_M\189\212\DEL\164\208\199\184EBt[Cw\160\232\217\146\144+\203\178\ENQ\DEL\209\150\195\215}!\247\220E)\180]\206]\ACK\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL"

-- these are signed (received) provenance versions
cmdRPC1', cmdRPC2' :: Command
cmdRPC1' = (\(Right v) -> v) $ fromWire keySet cmdSignedRPC1
cmdRPC2' = (\(Right v) -> v) $ fromWire keySet cmdSignedRPC2

-- #############################################
-- CommandResponse, with and without provenance
-- #############################################
cmdrRPC :: CommandResponse
cmdrRPC = CommandResponse
  { _cmdrResult     = CommandResult "account created: foo"
  , _cmdrLeaderId   = nodeIdLeader
  , _cmdrNodeId     = nodeIdLeader
  , _cmdrRequestId  = RequestId 1
  , _cmdrProvenance = NewMsg
  }

cmdrSignedRPC :: SignedRPC
cmdrSignedRPC = toWire nodeIdLeader privKeyLeader cmdrRPC

-- ########################################################
-- LogEntry(s) and Seq LogEntry with correct hashes.
-- LogEntry is not an RPC but is(are) nested in other RPCs.
-- Given this, they are handled differently (no provenance)
-- ########################################################
logEntry1, logEntry2 :: LogEntry
logEntry1 = LogEntry
  { _leTerm    = Term 0
  , _leCommand = cmdRPC1'
  , _leHash    = "\237\157D\GS\158k\214\188\219.,\248\226\232\174\227\228\236R\t\189\&3v\NUL\255\&5\224\&4|\178\STX\252"
  }
logEntry2 = LogEntry
  { _leTerm    = Term 0
  , _leCommand = cmdRPC2'
  , _leHash    = "\244\136\187c\222\164\131\178;D)M\DEL\142|\251Kv\213\186\247q;3`\194\227O\US\223Q\157"
  }

leSeq, leSeqDecoded :: Seq LogEntry
leSeq = Seq.fromList [logEntry1, logEntry2]
leSeqDecoded = (\(Right v) -> v) $ decodeLEWire keySet leWire

leWire :: [LEWire]
leWire = encodeLEWire nodeIdLeader privKeyLeader leSeq

-- ################################################
-- RequestVoteResponse, with and without provenance
-- ################################################

rvrRPC1, rvrRPC2 :: RequestVoteResponse
rvrRPC1 = RequestVoteResponse
  { _rvrTerm        = Term 0
  , _rvrCurLogIndex = LogIndex (-1)
  , _rvrNodeId      = nodeIdLeader
  , _voteGranted    = True
  , _rvrCandidateId = nodeIdLeader
  , _rvrProvenance  = NewMsg
  }
rvrRPC2 = RequestVoteResponse
  { _rvrTerm        = Term 0
  , _rvrCurLogIndex = LogIndex (-1)
  , _rvrNodeId      = nodeIdFollower
  , _voteGranted    = True
  , _rvrCandidateId = nodeIdLeader
  , _rvrProvenance  = NewMsg
  }

rvrSignedRPC1, rvrSignedRPC2 :: SignedRPC
rvrSignedRPC1 = toWire nodeIdLeader privKeyLeader rvrRPC1
rvrSignedRPC2 = toWire nodeIdFollower privKeyFollower rvrRPC2

rvrRPC1', rvrRPC2' :: RequestVoteResponse
rvrRPC1' = (\(Right v) -> v) $ fromWire keySet rvrSignedRPC1
rvrRPC2' = (\(Right v) -> v) $ fromWire keySet rvrSignedRPC2

rvrRPCSet' :: Set RequestVoteResponse
rvrRPCSet' = Set.fromList [rvrRPC1', rvrRPC2']

rvrSignedRPCList :: [SignedRPC]
rvrSignedRPCList = [rvrSignedRPC1, rvrSignedRPC2]

-- #############################################
-- AppendEntries, with and without provenance
-- #############################################
aeRPC, aeRpcReceived, aeEmptyRPC, aeEmptyRpcReceived :: AppendEntries
aeRPC = AppendEntries
  { _aeTerm        = Term 0
  , _leaderId      = nodeIdLeader
  , _prevLogIndex  = LogIndex (-1)
  , _prevLogTerm   = Term 0
  , _aeEntries     = leSeq
  , _aeQuorumVotes = rvrRPCSet'
  , _aeProvenance  = NewMsg
  }
aeEmptyRPC = AppendEntries
  { _aeTerm        = Term 0
  , _leaderId      = nodeIdLeader
  , _prevLogIndex  = LogIndex (-1)
  , _prevLogTerm   = Term 0
  , _aeEntries     = Seq.empty
  , _aeQuorumVotes = Set.empty
  , _aeProvenance  = NewMsg
  }
-- aeRpcReceived = (\(Right v) -> v) $ fromWire keySet aeSignedRPC
aeRpcReceived = AppendEntries {_aeTerm = Term 0, _leaderId = NodeID {_host = "localhost", _port = 10000}, _prevLogIndex = LogIndex (-1), _prevLogTerm = Term 0, _aeEntries = Seq.fromList [LogEntry {_leTerm = Term 0, _leCommand = Command {_cmdEntry = CommandEntry {unCommandEntry = "CreateAccount foo"}, _cmdClientId = NodeID {_host = "localhost", _port = 10002}, _cmdRequestId = RequestId 0, _cmdProvenance = ReceivedMsg {_pDig = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10002}, _digSig = "x\237u\EOT\203\218\162\SOH\185#\137\CAN\142\143-d\156\151;\231\182}>\136\DC3\186:\GS!C\134\r\NAK\193\"-cy\185\181\t\200ff\154\201u\202\146\ESC\179\DC1_\152\200(YU\218\"`\ESC\219\152q\189\"\213K\202\215V\DC1\162\209\168M\133\188$\ENQ1\192\237{\210\201f_M\189\212\DEL\164\208\199\184EBt[Cw\160\232\217\146\144+\203\178\ENQ\DEL\209\150\195\215}!\247\220E)\180]\206]\ACK", _digPubkey = PublicKey {public_size = 128, public_n = 106252368639070633938244027838812466487634971459399633948485579058064750184804467292629472697808998989066368983424031700876663753846147139515953278402011718215436563286250115914185011343557536197541367961085118851954966833333275851022828003953887053315417450038702459750117667520446623825484282212798093912159, public_e = 65537}, _digType = CMD}, _pOrig = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL"}}, _leHash = "\237\157D\GS\158k\214\188\219.,\248\226\232\174\227\228\236R\t\189\&3v\NUL\255\&5\224\&4|\178\STX\252"},LogEntry {_leTerm = Term 0, _leCommand = Command {_cmdEntry = CommandEntry {unCommandEntry = "CreateAccount foo"}, _cmdClientId = NodeID {_host = "localhost", _port = 10002}, _cmdRequestId = RequestId 1, _cmdProvenance = ReceivedMsg {_pDig = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10002}, _digSig = "'\176`w\186\&8\192\172\159l7\140\159\196\226eO\189\225Cv\210r\131/\247\225)\221\230!kL\131^B\231\DC1y\223\223\203\DC4\252\250;\157\153]\177O\255\142tV\250\192(y\216=I\RSb\190\187\NAK0;\175q\US\"S8SyV\a\226\&5\SO1\SOH-c{\b\193w\196\137\DC2\152\192G\252\&0G\US\206\RS\SOH\STXW\214\130\158G\206\169\207\129mk\154w}\208\172\218x\ACKsc\SYN\248#", _digPubkey = PublicKey {public_size = 128, public_n = 106252368639070633938244027838812466487634971459399633948485579058064750184804467292629472697808998989066368983424031700876663753846147139515953278402011718215436563286250115914185011343557536197541367961085118851954966833333275851022828003953887053315417450038702459750117667520446623825484282212798093912159, public_e = 65537}, _digType = CMD}, _pOrig = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\SOH"}}, _leHash = "\244\136\187c\222\164\131\178;D)M\DEL\142|\251Kv\213\186\247q;3`\194\227O\US\223Q\157"}], _aeQuorumVotes = Set.fromList [RequestVoteResponse {_rvrTerm = Term 0, _rvrCurLogIndex = LogIndex (-1), _rvrNodeId = NodeID {_host = "localhost", _port = 10000}, _voteGranted = True, _rvrCandidateId = NodeID {_host = "localhost", _port = 10000}, _rvrProvenance = ReceivedMsg {_pDig = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10000}, _digSig = "\DEL\200\NUL\138\193\129\231\190*\143\196\175a\215f\252\230\233\238.\244\138\228/\USP\173\151\142\165\223\FS\DC2\165\v\255s\139:\217\NAK\235A\148\140\199\180\&5\148\SOH\144\243P\179\196\&1\DC4\240\SYN\136=O\221\201\&3\224\183\189\172\234\164q\CAN\252\129\ETBOu-?+v\138b\a\DC4\RS\224f\181\n\250\DLE\176 \164\DC3Kl%\144\242\195v\DC4F\185\b\239\138\STXC\211\228$\191_\251\244\190\235\ETB\180\&4\ESCb\188\150", _digPubkey = PublicKey {public_size = 128, public_n = 143263094045483237413672742110806909557046787889291330401749751443369156063681858601975919855307842489235960299544273678048933580691559560784431105517057635455255146471809872702665529086654681916300619471314964172045542731305151294857601932085639875342307156397078951049517603494584167375520281289470658070821, public_e = 65537}, _digType = RVR}, _pOrig = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE"}},RequestVoteResponse {_rvrTerm = Term 0, _rvrCurLogIndex = LogIndex (-1), _rvrNodeId = NodeID {_host = "localhost", _port = 10001}, _voteGranted = True, _rvrCandidateId = NodeID {_host = "localhost", _port = 10000}, _rvrProvenance = ReceivedMsg {_pDig = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10001}, _digSig = "\161\217\219cO\SOHo\229*\235.\214\DLE\138Xe\SYN\ACK\138\234\&8g\164At\213\&9\GS\ETX\255}\219\DC4\232\244+\FS\225\159V\232\&9\138\217<F\ACK\NAKH\138\143B09\140\197x\166\168T\224|Z\189\158_\214\198Cfty\184`M\252V#\199q\206\209\147\165\SOHw\188\136\254\228\203\183\182B\164\211b\220\247\202\ETX\219\171lo\241IV\227\&1\216So\189\244e!2\190Fv\147i\SI.+1\201", _digPubkey = PublicKey {public_size = 128, public_n = 119734587589518990148219161431156442604320649075830559997839966910663760506098828080257917947217357217568770968568912187185962902759815037372954576824527044099430785533420222306796220280055320145935645419601056718741502607027250695371136410369973248364689692994952014429670625261164422497595026998844835804983, public_e = 65537}, _digType = RVR}, _pOrig = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE"}}], _aeProvenance = ReceivedMsg {_pDig = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10000}, _digSig = ";\n2\211\195\234T\147x\198\EM\132)\168UU\172\206\143\217\152\DLEUu\227hM\135\201(\223q\SI\ENQEU\154VS\184\183H\188\247\&7t\251\243$\152t\135j\ESC\147\128\232\255+\219\"\246\ACK\STX\240I\193\223`\249,\189\178\183R!\238b~-\212\242\216k\SYN\160\246\CANP\158\218]\144-3\ETB\217\DC2\160 z\184@\146\146\139\228\207\NAK\243R|\224\202\178\175\169\207l\206E\178\128\222\&5\190/\163", _digPubkey = PublicKey {public_size = 128, public_n = 143263094045483237413672742110806909557046787889291330401749751443369156063681858601975919855307842489235960299544273678048933580691559560784431105517057635455255146471809872702665529086654681916300619471314964172045542731305151294857601932085639875342307156397078951049517603494584167375520281289470658070821, public_e = 65537}, _digType = AE}, _pOrig = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128x\237u\EOT\203\218\162\SOH\185#\137\CAN\142\143-d\156\151;\231\182}>\136\DC3\186:\GS!C\134\r\NAK\193\"-cy\185\181\t\200ff\154\201u\202\146\ESC\179\DC1_\152\200(YU\218\"`\ESC\219\152q\189\"\213K\202\215V\DC1\162\209\168M\133\188$\ENQ1\192\237{\210\201f_M\189\212\DEL\164\208\199\184EBt[Cw\160\232\217\146\144+\203\178\ENQ\DEL\209\150\195\215}!\247\220E)\180]\206]\ACK\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL \237\157D\GS\158k\214\188\219.,\248\226\232\174\227\228\236R\t\189\&3v\NUL\255\&5\224\&4|\178\STX\252\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128'\176`w\186\&8\192\172\159l7\140\159\196\226eO\189\225Cv\210r\131/\247\225)\221\230!kL\131^B\231\DC1y\223\223\203\DC4\252\250;\157\153]\177O\255\142tV\250\192(y\216=I\RSb\190\187\NAK0;\175q\US\"S8SyV\a\226\&5\SO1\SOH-c{\b\193w\196\137\DC2\152\192G\252\&0G\US\206\RS\SOH\STXW\214\130\158G\206\169\207\129mk\154w}\208\172\218x\ACKsc\SYN\248#\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL \244\136\187c\222\164\131\178;D)M\DEL\142|\251Kv\213\186\247q;3`\194\227O\US\223Q\157\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\DEL\200\NUL\138\193\129\231\190*\143\196\175a\215f\252\230\233\238.\244\138\228/\USP\173\151\142\165\223\FS\DC2\165\v\255s\139:\217\NAK\235A\148\140\199\180\&5\148\SOH\144\243P\179\196\&1\DC4\240\SYN\136=O\221\201\&3\224\183\189\172\234\164q\CAN\252\129\ETBOu-?+v\138b\a\DC4\RS\224f\181\n\250\DLE\176 \164\DC3Kl%\144\242\195v\DC4F\185\b\239\138\STXC\211\228$\191_\251\244\190\235\ETB\180\&4\ESCb\188\150\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128%\201!hhKn\232i\153\231\160\194\145\195J\224\242\142\177A[7\SYN\168Nb\238/2SU-\179\f\219\199\158\210\234P\EOT\185k\202\STX\161y\245q\195t\137\149?\176`f\216Ak\227\143h$\255\254\143\130W\NAKg:`\152\173T\n!o\217\&2V\143\a\140\ENQ=\179z\159a$5\182;\ETB\244\249e\199\DC4T\223\227t'\133\221\154\235\RSN\157\b\195\165\150\173\144\167\162\170\204Zo\ETX\204\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\161\217\219cO\SOHo\229*\235.\214\DLE\138Xe\SYN\ACK\138\234\&8g\164At\213\&9\GS\ETX\255}\219\DC4\232\244+\FS\225\159V\232\&9\138\217<F\ACK\NAKH\138\143B09\140\197x\166\168T\224|Z\189\158_\214\198Cfty\184`M\252V#\199q\206\209\147\165\SOHw\188\136\254\228\203\183\182B\164\211b\220\247\202\ETX\219\171lo\241IV\227\&1\216So\189\244e!2\190Fv\147i\SI.+1\201\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\&7\183\212\243Zn\FS\239t\174\&1t\203\GSM0\a\239\t\167\248\SO\213\143\n\SYN\DC3\176\172\\\t,\160\247B\237\213\193\162\164\&1\f\245\SO:\186c\136\230\242\237U\210\216\161\&0gF\210\&3\226\246\192\179\141q\244\217\SI.\134\244\211\DC3ox*~O&\132lm,\233pA\214\180'*\255\&9\EOT\170\227\140\168\246\208\191\193\CAN\170\EMTfK\DC3G\236UR\EM\247[\152\130\221\207\232\227e\135r\249\129\170\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE"}}
aeEmptyRpcReceived = AppendEntries {_aeTerm = Term 0, _leaderId = NodeID {_host = "localhost", _port = 10000}, _prevLogIndex = LogIndex (-1), _prevLogTerm = Term 0, _aeEntries = Seq.empty, _aeQuorumVotes = Set.empty, _aeProvenance = ReceivedMsg {_pDig = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10000}, _digSig = "\148\DEL+\150\160c\SIchE\179\155\160\ETX6\n\141\250\236\171\251:DlsZ\235YA\157\\i<3\211?jN\149@\163C\173\141\251Wg\197\250?\202\249'\EOT\251W\213\235\227\237>]\218\251Fz\190|G\\\212\157,Qr\254\245\231\SOHI\198\232^\246\218\166\v:&\206\244\234\163'\152\ETX\222\160klJN\186\196\ACK\ESCQ\148\DC4c\229\RSo+\135\230\210\GS\SOH\213\175\r\137\197\223\"\SI\215", _digPubkey = PublicKey {public_size = 128, public_n = 143263094045483237413672742110806909557046787889291330401749751443369156063681858601975919855307842489235960299544273678048933580691559560784431105517057635455255146471809872702665529086654681916300619471314964172045542731305151294857601932085639875342307156397078951049517603494584167375520281289470658070821, public_e = 65537}, _digType = AE}, _pOrig = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL"}}

aeSignedRPC, aeEmptySignedRPC :: SignedRPC
-- aeSignedRPC = toWire nodeIdLeader privKeyLeader aeRPC
aeSignedRPC = SignedRPC {_sigDigest = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10000}, _digSig = ";\n2\211\195\234T\147x\198\EM\132)\168UU\172\206\143\217\152\DLEUu\227hM\135\201(\223q\SI\ENQEU\154VS\184\183H\188\247\&7t\251\243$\152t\135j\ESC\147\128\232\255+\219\"\246\ACK\STX\240I\193\223`\249,\189\178\183R!\238b~-\212\242\216k\SYN\160\246\CANP\158\218]\144-3\ETB\217\DC2\160 z\184@\146\146\139\228\207\NAK\243R|\224\202\178\175\169\207l\206E\178\128\222\&5\190/\163", _digPubkey = PublicKey {public_size = 128, public_n = 143263094045483237413672742110806909557046787889291330401749751443369156063681858601975919855307842489235960299544273678048933580691559560784431105517057635455255146471809872702665529086654681916300619471314964172045542731305151294857601932085639875342307156397078951049517603494584167375520281289470658070821, public_e = 65537}, _digType = AE}, _sigBody = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128x\237u\EOT\203\218\162\SOH\185#\137\CAN\142\143-d\156\151;\231\182}>\136\DC3\186:\GS!C\134\r\NAK\193\"-cy\185\181\t\200ff\154\201u\202\146\ESC\179\DC1_\152\200(YU\218\"`\ESC\219\152q\189\"\213K\202\215V\DC1\162\209\168M\133\188$\ENQ1\192\237{\210\201f_M\189\212\DEL\164\208\199\184EBt[Cw\160\232\217\146\144+\203\178\ENQ\DEL\209\150\195\215}!\247\220E)\180]\206]\ACK\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL \237\157D\GS\158k\214\188\219.,\248\226\232\174\227\228\236R\t\189\&3v\NUL\255\&5\224\&4|\178\STX\252\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128'\176`w\186\&8\192\172\159l7\140\159\196\226eO\189\225Cv\210r\131/\247\225)\221\230!kL\131^B\231\DC1y\223\223\203\DC4\252\250;\157\153]\177O\255\142tV\250\192(y\216=I\RSb\190\187\NAK0;\175q\US\"S8SyV\a\226\&5\SO1\SOH-c{\b\193w\196\137\DC2\152\192G\252\&0G\US\206\RS\SOH\STXW\214\130\158G\206\169\207\129mk\154w}\208\172\218x\ACKsc\SYN\248#\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL \244\136\187c\222\164\131\178;D)M\DEL\142|\251Kv\213\186\247q;3`\194\227O\US\223Q\157\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\DEL\200\NUL\138\193\129\231\190*\143\196\175a\215f\252\230\233\238.\244\138\228/\USP\173\151\142\165\223\FS\DC2\165\v\255s\139:\217\NAK\235A\148\140\199\180\&5\148\SOH\144\243P\179\196\&1\DC4\240\SYN\136=O\221\201\&3\224\183\189\172\234\164q\CAN\252\129\ETBOu-?+v\138b\a\DC4\RS\224f\181\n\250\DLE\176 \164\DC3Kl%\144\242\195v\DC4F\185\b\239\138\STXC\211\228$\191_\251\244\190\235\ETB\180\&4\ESCb\188\150\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128%\201!hhKn\232i\153\231\160\194\145\195J\224\242\142\177A[7\SYN\168Nb\238/2SU-\179\f\219\199\158\210\234P\EOT\185k\202\STX\161y\245q\195t\137\149?\176`f\216Ak\227\143h$\255\254\143\130W\NAKg:`\152\173T\n!o\217\&2V\143\a\140\ENQ=\179z\159a$5\182;\ETB\244\249e\199\DC4T\223\227t'\133\221\154\235\RSN\157\b\195\165\150\173\144\167\162\170\204Zo\ETX\204\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\161\217\219cO\SOHo\229*\235.\214\DLE\138Xe\SYN\ACK\138\234\&8g\164At\213\&9\GS\ETX\255}\219\DC4\232\244+\FS\225\159V\232\&9\138\217<F\ACK\NAKH\138\143B09\140\197x\166\168T\224|Z\189\158_\214\198Cfty\184`M\252V#\199q\206\209\147\165\SOHw\188\136\254\228\203\183\182B\164\211b\220\247\202\ETX\219\171lo\241IV\227\&1\216So\189\244e!2\190Fv\147i\SI.+1\201\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\&7\183\212\243Zn\FS\239t\174\&1t\203\GSM0\a\239\t\167\248\SO\213\143\n\SYN\DC3\176\172\\\t,\160\247B\237\213\193\162\164\&1\f\245\SO:\186c\136\230\242\237U\210\216\161\&0gF\210\&3\226\246\192\179\141q\244\217\SI.\134\244\211\DC3ox*~O&\132lm,\233pA\214\180'*\255\&9\EOT\170\227\140\168\246\208\191\193\CAN\170\EMTfK\DC3G\236UR\EM\247[\152\130\221\207\232\227e\135r\249\129\170\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE"}
aeEmptySignedRPC = SignedRPC {_sigDigest = Digest {_digNodeId = NodeID {_host = "localhost", _port = 10000}, _digSig = "\148\DEL+\150\160c\SIchE\179\155\160\ETX6\n\141\250\236\171\251:DlsZ\235YA\157\\i<3\211?jN\149@\163C\173\141\251Wg\197\250?\202\249'\EOT\251W\213\235\227\237>]\218\251Fz\190|G\\\212\157,Qr\254\245\231\SOHI\198\232^\246\218\166\v:&\206\244\234\163'\152\ETX\222\160klJN\186\196\ACK\ESCQ\148\DC4c\229\RSo+\135\230\210\GS\SOH\213\175\r\137\197\223\"\SI\215", _digPubkey = PublicKey {public_size = 128, public_n = 143263094045483237413672742110806909557046787889291330401749751443369156063681858601975919855307842489235960299544273678048933580691559560784431105517057635455255146471809872702665529086654681916300619471314964172045542731305151294857601932085639875342307156397078951049517603494584167375520281289470658070821, public_e = 65537}, _digType = AE}, _sigBody = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL"}

aeSignedRpcBS, aeEmptySignedRpcBS :: ByteString
aeSignedRpcBS = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128;\n2\211\195\234T\147x\198\EM\132)\168UU\172\206\143\217\152\DLEUu\227hM\135\201(\223q\SI\ENQEU\154VS\184\183H\188\247\&7t\251\243$\152t\135j\ESC\147\128\232\255+\219\"\246\ACK\STX\240I\193\223`\249,\189\178\183R!\238b~-\212\242\216k\SYN\160\246\CANP\158\218]\144-3\ETB\217\DC2\160 z\184@\146\146\139\228\207\NAK\243R|\224\202\178\175\169\207l\206E\178\128\222\&5\190/\163\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128%\201!hhKn\232i\153\231\160\194\145\195J\224\242\142\177A[7\SYN\168Nb\238/2SU-\179\f\219\199\158\210\234P\EOT\185k\202\STX\161y\245q\195t\137\149?\176`f\216Ak\227\143h$\255\254\143\130W\NAKg:`\152\173T\n!o\217\&2V\143\a\140\ENQ=\179z\159a$5\182;\ETB\244\249e\199\DC4T\223\227t'\133\221\154\235\RSN\157\b\195\165\150\173\144\167\162\170\204Zo\ETX\204\NUL\NUL\SOH\NUL\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\ACK\159\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128x\237u\EOT\203\218\162\SOH\185#\137\CAN\142\143-d\156\151;\231\182}>\136\DC3\186:\GS!C\134\r\NAK\193\"-cy\185\181\t\200ff\154\201u\202\146\ESC\179\DC1_\152\200(YU\218\"`\ESC\219\152q\189\"\213K\202\215V\DC1\162\209\168M\133\188$\ENQ1\192\237{\210\201f_M\189\212\DEL\164\208\199\184EBt[Cw\160\232\217\146\144+\203\178\ENQ\DEL\209\150\195\215}!\247\220E)\180]\206]\ACK\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL \237\157D\GS\158k\214\188\219.,\248\226\232\174\227\228\236R\t\189\&3v\NUL\255\&5\224\&4|\178\STX\252\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128'\176`w\186\&8\192\172\159l7\140\159\196\226eO\189\225Cv\210r\131/\247\225)\221\230!kL\131^B\231\DC1y\223\223\203\DC4\252\250;\157\153]\177O\255\142tV\250\192(y\216=I\RSb\190\187\NAK0;\175q\US\"S8SyV\a\226\&5\SO1\SOH-c{\b\193w\196\137\DC2\152\192G\252\&0G\US\206\RS\SOH\STXW\214\130\158G\206\169\207\129mk\154w}\208\172\218x\ACKsc\SYN\248#\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL \244\136\187c\222\164\131\178;D)M\DEL\142|\251Kv\213\186\247q;3`\194\227O\US\223Q\157\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\DEL\200\NUL\138\193\129\231\190*\143\196\175a\215f\252\230\233\238.\244\138\228/\USP\173\151\142\165\223\FS\DC2\165\v\255s\139:\217\NAK\235A\148\140\199\180\&5\148\SOH\144\243P\179\196\&1\DC4\240\SYN\136=O\221\201\&3\224\183\189\172\234\164q\CAN\252\129\ETBOu-?+v\138b\a\DC4\RS\224f\181\n\250\DLE\176 \164\DC3Kl%\144\242\195v\DC4F\185\b\239\138\STXC\211\228$\191_\251\244\190\235\ETB\180\&4\ESCb\188\150\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128%\201!hhKn\232i\153\231\160\194\145\195J\224\242\142\177A[7\SYN\168Nb\238/2SU-\179\f\219\199\158\210\234P\EOT\185k\202\STX\161y\245q\195t\137\149?\176`f\216Ak\227\143h$\255\254\143\130W\NAKg:`\152\173T\n!o\217\&2V\143\a\140\ENQ=\179z\159a$5\182;\ETB\244\249e\199\DC4T\223\227t'\133\221\154\235\RSN\157\b\195\165\150\173\144\167\162\170\204Zo\ETX\204\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\161\217\219cO\SOHo\229*\235.\214\DLE\138Xe\SYN\ACK\138\234\&8g\164At\213\&9\GS\ETX\255}\219\DC4\232\244+\FS\225\159V\232\&9\138\217<F\ACK\NAKH\138\143B09\140\197x\166\168T\224|Z\189\158_\214\198Cfty\184`M\252V#\199q\206\209\147\165\SOHw\188\136\254\228\203\183\182B\164\211b\220\247\202\ETX\219\171lo\241IV\227\&1\216So\189\244e!2\190Fv\147i\SI.+1\201\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\&7\183\212\243Zn\FS\239t\174\&1t\203\GSM0\a\239\t\167\248\SO\213\143\n\SYN\DC3\176\172\\\t,\160\247B\237\213\193\162\164\&1\f\245\SO:\186c\136\230\242\237U\210\216\161\&0gF\210\&3\226\246\192\179\141q\244\217\SI.\134\244\211\DC3ox*~O&\132lm,\233pA\214\180'*\255\&9\EOT\170\227\140\168\246\208\191\193\CAN\170\EMTfK\DC3G\236UR\EM\247[\152\130\221\207\232\227e\135r\249\129\170\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE"
aeEmptySignedRpcBS = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\148\DEL+\150\160c\SIchE\179\155\160\ETX6\n\141\250\236\171\251:DlsZ\235YA\157\\i<3\211?jN\149@\163C\173\141\251Wg\197\250?\202\249'\EOT\251W\213\235\227\237>]\218\251Fz\190|G\\\212\157,Qr\254\245\231\SOHI\198\232^\246\218\166\v:&\206\244\234\163'\152\ETX\222\160klJN\186\196\ACK\ESCQ\148\DC4c\229\RSo+\135\230\210\GS\SOH\213\175\r\137\197\223\"\SI\215\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128%\201!hhKn\232i\153\231\160\194\145\195J\224\242\142\177A[7\SYN\168Nb\238/2SU-\179\f\219\199\158\210\234P\EOT\185k\202\STX\161y\245q\195t\137\149?\176`f\216Ak\227\143h$\255\254\143\130W\NAKg:`\152\173T\n!o\217\&2V\143\a\140\ENQ=\179z\159a$5\182;\ETB\244\249e\199\DC4T\223\227t'\133\221\154\235\RSN\157\b\195\165\150\173\144\167\162\170\204Zo\ETX\204\NUL\NUL\SOH\NUL\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NULA\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL"

aeRPC' :: RequestVoteResponse
aeRPC' = (\(Right v) -> v) $ fromWire keySet aeSignedRPC

-- #####################
-- AppendEntriesResponse
-- #####################
aerRPC :: AppendEntriesResponse
aerRPC = AppendEntriesResponse
  { _aerTerm       = Term 0
  , _aerNodeId     = nodeIdFollower
  , _aerSuccess    = True
  , _aerConvinced  = True
  , _aerIndex      = LogIndex 1
  , _aerHash       = "\244\136\187c\222\164\131\178;D)M\DEL\142|\251Kv\213\186\247q;3`\194\227O\US\223Q\157"
  , _aerProvenance = NewMsg
  }

aerSignedRPC :: SignedRPC
aerSignedRPC = toWire nodeIdFollower privKeyFollower aerRPC

-- ###########
-- RequestVote
-- ###########
rvRPC :: RequestVote
rvRPC = RequestVote
  { _rvTerm        = Term 0
  , _rvCandidateId = nodeIdLeader
  , _lastLogIndex  = LogIndex (-1)
  , _lastLogTerm   = Term (-1)
  , _rvProvenance  = NewMsg
  }

rvSignedRPC :: SignedRPC
rvSignedRPC = toWire nodeIdLeader privKeyLeader rvRPC

-- ##########
-- Revolution
-- ##########
revRPC :: Revolution
revRPC = Revolution
  { _revClientId   = nodeIdClient
  , _revLeaderId   = nodeIdLeader
  , _revRequestId  = RequestId 2
  , _revProvenance = NewMsg
  }

revSignedRPC :: SignedRPC
revSignedRPC = toWire nodeIdClient privKeyClient revRPC

-- ## Old Serialization Strategy

data OldAppendEntries = OldAppendEntries
  { _oaeTerm        :: !Term
  , _oleaderId      :: !NodeID
  , _oprevLogIndex  :: !LogIndex
  , _oprevLogTerm   :: !Term
  , _oaeEntries     :: !(Seq LogEntry)
  , _oaeQuorumVotes :: !(Set RequestVoteResponse)
  , _oaeSig  :: LB.ByteString
  }
  deriving (Show, Eq, Generic)

instance Serialize OldAppendEntries

oaeRPC, oaeRPC', oaeEmptyRPC, oaeEmptyRPC' :: OldAppendEntries
oaeRPC = OldAppendEntries
  { _oaeTerm        = Term 0
  , _oleaderId      = nodeIdLeader
  , _oprevLogIndex  = LogIndex (-1)
  , _oprevLogTerm   = Term 0
  , _oaeEntries     = leSeq
  , _oaeQuorumVotes = rvrRPCSet'
  , _oaeSig  = LB.empty
  }
oaeRPC' = OldAppendEntries
  { _oaeTerm        = Term 0
  , _oleaderId      = nodeIdLeader
  , _oprevLogIndex  = LogIndex (-1)
  , _oprevLogTerm   = Term 0
  , _oaeEntries     = leSeq
  , _oaeQuorumVotes = rvrRPCSet'
  , _oaeSig  = "!k\DLE\164@x5\139\219\DC1cx\132-\176;s\216 y\129\162\167\220R\199\254\185\239\SOV\r o\191\160\204\215)\ACK\220\SO$7kEZ\169\195EL\157\253\218\143\189\203\DEL\136\148\206\DC1\v[k\201\212\ETB3\RS\131\203/\135\a\225\&2\SO?ZX\SO\249\DC4\STX\234\140\181M\168Y\EM\160\148\174\159\221\221A#\168\SI\DC3\128G\178\&0u\185\ENQQV\130\153\172\190\206-\ACK\198\181n>p\190\175\NAKM"
  }
oaeEmptyRPC = OldAppendEntries
  { _oaeTerm        = Term 0
  , _oleaderId      = nodeIdLeader
  , _oprevLogIndex  = LogIndex (-1)
  , _oprevLogTerm   = Term 0
  , _oaeEntries     = Seq.empty
  , _oaeQuorumVotes = rvrRPCSet'
  , _oaeSig  = LB.empty
  }
oaeEmptyRPC' = OldAppendEntries
  { _oaeTerm        = Term 0
  , _oleaderId      = nodeIdLeader
  , _oprevLogIndex  = LogIndex (-1)
  , _oprevLogTerm   = Term 0
  , _oaeEntries     = Seq.empty
  , _oaeQuorumVotes = rvrRPCSet'
  , _oaeSig  = "*\GS\218\&6e&\139\254W\131\254\DLE\v\188\204#\228F<S>m\203\185\134\189\DC1@(uu\136D\229\&6\SUB=\221\171\131\181\173\189\237~>Dj\DLE\192}\SYN\142\227\DC4\208'{'3\165ug\197<\ETX8\f\r\141\230KU\154\210-U\132\252CO\129\196\173d\179^\242\189i\237J\SYN\158\251\STXl$9\228\&5\SUBrk:\155\198\181\180\170\SYN\139r\189\\\236\158&Y\158\151\200\240\172\233Ey\223"
  }

oaeSerRPC, oaeEmptySerRPC :: ByteString
oaeSerRPC = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128x\237u\EOT\203\218\162\SOH\185#\137\CAN\142\143-d\156\151;\231\182}>\136\DC3\186:\GS!C\134\r\NAK\193\"-cy\185\181\t\200ff\154\201u\202\146\ESC\179\DC1_\152\200(YU\218\"`\ESC\219\152q\189\"\213K\202\215V\DC1\162\209\168M\133\188$\ENQ1\192\237{\210\201f_M\189\212\DEL\164\208\199\184EBt[Cw\160\232\217\146\144+\203\178\ENQ\DEL\209\150\195\215}!\247\220E)\180]\206]\ACK\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL \237\157D\GS\158k\214\188\219.,\248\226\232\174\227\228\236R\t\189\&3v\NUL\255\&5\224\&4|\178\STX\252\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128'\176`w\186\&8\192\172\159l7\140\159\196\226eO\189\225Cv\210r\131/\247\225)\221\230!kL\131^B\231\DC1y\223\223\203\DC4\252\250;\157\153]\177O\255\142tV\250\192(y\216=I\RSb\190\187\NAK0;\175q\US\"S8SyV\a\226\&5\SO1\SOH-c{\b\193w\196\137\DC2\152\192G\252\&0G\US\206\RS\SOH\STXW\214\130\158G\206\169\207\129mk\154w}\208\172\218x\ACKsc\SYN\248#\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128_\232$W\245ML\233\138\139m\129\164a\130>\180\SOH\150\149W\246\240RY\t\150\174\NAK1\139o\211\235v\FS\243\165\229#\187\240\150\252\DC2\249\186\163\ESC \DEL\164\253\147\&4W<pj\136\DC4\ETXi\227\DC1%\198\168\&5\CAN\129\140\STX\134\158\242\156\199\181\215}~F\131_P\226\165Zm@NoT\232I{\CAN\EM\209\t\205\217\235\255\172\239\v7a{ \US\216\201\&7yfO\227\166X\200\200\NUL\243N\151\NUL\NUL\SOH\NUL\SOH\EOT\NUL\NUL\NUL\NUL\NUL\NUL\NUL:\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL \244\136\187c\222\164\131\178;D)M\DEL\142|\251Kv\213\186\247q;3`\194\227O\US\223Q\157\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\DEL\200\NUL\138\193\129\231\190*\143\196\175a\215f\252\230\233\238.\244\138\228/\USP\173\151\142\165\223\FS\DC2\165\v\255s\139:\217\NAK\235A\148\140\199\180\&5\148\SOH\144\243P\179\196\&1\DC4\240\SYN\136=O\221\201\&3\224\183\189\172\234\164q\CAN\252\129\ETBOu-?+v\138b\a\DC4\RS\224f\181\n\250\DLE\176 \164\DC3Kl%\144\242\195v\DC4F\185\b\239\138\STXC\211\228$\191_\251\244\190\235\ETB\180\&4\ESCb\188\150\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128%\201!hhKn\232i\153\231\160\194\145\195J\224\242\142\177A[7\SYN\168Nb\238/2SU-\179\f\219\199\158\210\234P\EOT\185k\202\STX\161y\245q\195t\137\149?\176`f\216Ak\227\143h$\255\254\143\130W\NAKg:`\152\173T\n!o\217\&2V\143\a\140\ENQ=\179z\159a$5\182;\ETB\244\249e\199\DC4T\223\227t'\133\221\154\235\RSN\157\b\195\165\150\173\144\167\162\170\204Zo\ETX\204\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\161\217\219cO\SOHo\229*\235.\214\DLE\138Xe\SYN\ACK\138\234\&8g\164At\213\&9\GS\ETX\255}\219\DC4\232\244+\FS\225\159V\232\&9\138\217<F\ACK\NAKH\138\143B09\140\197x\166\168T\224|Z\189\158_\214\198Cfty\184`M\252V#\199q\206\209\147\165\SOHw\188\136\254\228\203\183\182B\164\211b\220\247\202\ETX\219\171lo\241IV\227\&1\216So\189\244e!2\190Fv\147i\SI.+1\201\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\&7\183\212\243Zn\FS\239t\174\&1t\203\GSM0\a\239\t\167\248\SO\213\143\n\SYN\DC3\176\172\\\t,\160\247B\237\213\193\162\164\&1\f\245\SO:\186c\136\230\242\237U\210\216\161\&0gF\210\&3\226\246\192\179\141q\244\217\SI.\134\244\211\DC3ox*~O&\132lm,\233pA\214\180'*\255\&9\EOT\170\227\140\168\246\208\191\193\CAN\170\EMTfK\DC3G\236UR\EM\247[\152\130\221\207\232\227e\135r\249\129\170\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128!k\DLE\164@x5\139\219\DC1cx\132-\176;s\216 y\129\162\167\220R\199\254\185\239\SOV\r o\191\160\204\215)\ACK\220\SO$7kEZ\169\195EL\157\253\218\143\189\203\DEL\136\148\206\DC1\v[k\201\212\ETB3\RS\131\203/\135\a\225\&2\SO?ZX\SO\249\DC4\STX\234\140\181M\168Y\EM\160\148\174\159\221\221A#\168\SI\DC3\128G\178\&0u\185\ENQQV\130\153\172\190\206-\ACK\198\181n>p\190\175\NAKM"
oaeEmptySerRPC = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\STX\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\DEL\200\NUL\138\193\129\231\190*\143\196\175a\215f\252\230\233\238.\244\138\228/\USP\173\151\142\165\223\FS\DC2\165\v\255s\139:\217\NAK\235A\148\140\199\180\&5\148\SOH\144\243P\179\196\&1\DC4\240\SYN\136=O\221\201\&3\224\183\189\172\234\164q\CAN\252\129\ETBOu-?+v\138b\a\DC4\RS\224f\181\n\250\DLE\176 \164\DC3Kl%\144\242\195v\DC4F\185\b\239\138\STXC\211\228$\191_\251\244\190\235\ETB\180\&4\ESCb\188\150\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128%\201!hhKn\232i\153\231\160\194\145\195J\224\242\142\177A[7\SYN\168Nb\238/2SU-\179\f\219\199\158\210\234P\EOT\185k\202\STX\161y\245q\195t\137\149?\176`f\216Ak\227\143h$\255\254\143\130W\NAKg:`\152\173T\n!o\217\&2V\143\a\140\ENQ=\179z\159a$5\182;\ETB\244\249e\199\DC4T\223\227t'\133\221\154\235\RSN\157\b\195\165\150\173\144\167\162\170\204Zo\ETX\204\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\161\217\219cO\SOHo\229*\235.\214\DLE\138Xe\SYN\ACK\138\234\&8g\164At\213\&9\GS\ETX\255}\219\DC4\232\244+\FS\225\159V\232\&9\138\217<F\ACK\NAKH\138\143B09\140\197x\166\168T\224|Z\189\158_\214\198Cfty\184`M\252V#\199q\206\209\147\165\SOHw\188\136\254\228\203\183\182B\164\211b\220\247\202\ETX\219\171lo\241IV\227\&1\216So\189\244e!2\190Fv\147i\SI.+1\201\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\SOH\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\&7\183\212\243Zn\FS\239t\174\&1t\203\GSM0\a\239\t\167\248\SO\213\143\n\SYN\DC3\176\172\\\t,\160\247B\237\213\193\162\164\&1\f\245\SO:\186c\136\230\242\237U\210\216\161\&0gF\210\&3\226\246\192\179\141q\244\217\SI.\134\244\211\DC3ox*~O&\132lm,\233pA\214\180'*\255\&9\EOT\170\227\140\168\246\208\191\193\CAN\170\EMTfK\DC3G\236UR\EM\247[\152\130\221\207\232\227e\135r\249\129\170\NUL\NUL\SOH\NUL\SOH\ETX\NUL\NUL\NUL\NUL\NUL\NUL\NULC\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\255\255\255\255\255\255\255\255\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC1\SOH\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DLE\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128*\GS\218\&6e&\139\254W\131\254\DLE\v\188\204#\228F<S>m\203\185\134\189\DC1@(uu\136D\229\&6\SUB=\221\171\131\181\173\189\237~>Dj\DLE\192}\SYN\142\227\DC4\208'{'3\165ug\197<\ETX8\f\r\141\230KU\154\210-U\132\252CO\129\196\173d\179^\242\189i\237J\SYN\158\251\STXl$9\228\&5\SUBrk:\155\198\181\180\170\SYN\139r\189\\\236\158&Y\158\151\200\240\172\233Ey\223"

oldAeSign :: OldAppendEntries -> OldAppendEntries
oldAeSign oae = oae {_oaeSig = sign privKeyLeader (encodeLazy $ oae {_oaeSig = LB.empty})}

oldAeVerify :: OldAppendEntries -> Bool
oldAeVerify oae = case Map.lookup nodeIdLeader $ _ksCluster keySet of
  Nothing -> False
  Just k -> verify k (encodeLazy $ oae {_oaeSig = LB.empty}) (_oaeSig oae)

oldAeEncode :: OldAppendEntries -> ByteString
oldAeEncode oae = encode $ oldAeSign oae

oldAeDecode :: ByteString -> OldAppendEntries
oldAeDecode bs = case decode bs of
  Left err -> error err
  Right v -> if oldAeVerify v
             then v
             else error "Failed to verify"

data OldCommand = OldCommand
  { _ocmdEntry      :: !CommandEntry
  , _ocmdClientId   :: !NodeID
  , _ocmdRequestId  :: !RequestId
  , _ocmdSig :: LB.ByteString
  }
  deriving (Show, Eq, Generic)
instance Serialize OldCommand -- again, for SQLite

ocmdRPC, ocmdSignedRPC :: OldCommand
ocmdRPC = OldCommand
  { _ocmdEntry = CommandEntry "CreateAccount foo"
  , _ocmdClientId = nodeIdClient
  , _ocmdRequestId = RequestId 0
  , _ocmdSig = LB.empty }
ocmdSignedRPC = OldCommand
  { _ocmdEntry = CommandEntry "CreateAccount foo"
  , _ocmdClientId = nodeIdClient
  , _ocmdRequestId = RequestId 0
  , _ocmdSig = "\202n\234\229\172\198\183X5\168\193\189\ETX\GS\213\&72\175~]\236\&7\200r\167\245\v\144\n\DC11\132H\233\146\ACKpkyw7\237\t4\243\229\152#\210\&6ZT\196\ENQ\209\176V%i\212\189\&9sr\209\a\204\171\190\233\"cO_\129\234\252\"\ETB3\197\213)\DC4\154\SUB\162\&1\135\141\GS\146@<\204\204z\nt]\181\168>\130(yj\191YK\196\DLEo\144L\176\217g\209\248\180?\131\&6\204\181\210&"}

ocmdSerRPC :: ByteString
ocmdSerRPC = "\NUL\NUL\NUL\NUL\NUL\NUL\NUL\DC1CreateAccount foo\NUL\NUL\NUL\NUL\NUL\NUL\NUL\tlocalhost\NUL\NUL\NUL\NUL\NUL\NUL'\DC2\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\128\202n\234\229\172\198\183X5\168\193\189\ETX\GS\213\&72\175~]\236\&7\200r\167\245\v\144\n\DC11\132H\233\146\ACKpkyw7\237\t4\243\229\152#\210\&6ZT\196\ENQ\209\176V%i\212\189\&9sr\209\a\204\171\190\233\"cO_\129\234\252\"\ETB3\197\213)\DC4\154\SUB\162\&1\135\141\GS\146@<\204\204z\nt]\181\168>\130(yj\191YK\196\DLEo\144L\176\217g\209\248\180?\131\&6\204\181\210&"

oldCmdSign :: OldCommand -> OldCommand
oldCmdSign ocmd = ocmd {_ocmdSig = sign privKeyLeader (encodeLazy $ ocmd {_ocmdSig = LB.empty})}

oldCmdVerify :: OldCommand -> Bool
oldCmdVerify ocmd = case Map.lookup nodeIdLeader $ _ksCluster keySet of
  Nothing -> False
  Just k -> verify k (encodeLazy $ ocmd {_ocmdSig = LB.empty}) (_ocmdSig ocmd)

oldCmdEncode :: OldCommand -> ByteString
oldCmdEncode ocmd = encode $ oldCmdSign ocmd

oldCmdDecode :: ByteString -> OldCommand
oldCmdDecode bs = case decode bs of
  Left err -> error err
  Right v -> if oldCmdVerify v
             then v
             else error "Failed to verify"
